pipeline {
    agent any

    stages {
        stage('Preparation') { 
            steps {
                // Get the code from the GitHub repository
                git branch: 'main', url: 'https://github.com/morshedgit/cicd-test-forntapp.git'
            }
        }

        stage('Build') {
            environment {
                // Define environment variables for the build
                CONTENTFUL_SPACE_ID = "${env.CONTENTFUL_SPACE_ID}"
                CONTENTFUL_ACCESS_TOKEN = "${env.CONTENTFUL_ACCESS_TOKEN}"
                CONTENTFUL_ENVIRONMENT = "${env.CONTENTFUL_ENVIRONMENT}"
                CONTENTFUL_PREVIEW_ACCESS_TOKEN = "${env.CONTENTFUL_PREVIEW_ACCESS_TOKEN}"
                CONTENTFUL_PREVIEW_SECRET = "${env.CONTENTFUL_PREVIEW_SECRET}"
            }
            steps {
                script {
                    // Wrapping the Docker commands inside a script block
                    docker.withRegistry('http://host.docker.internal:5000') {
                        
                        def customImage = docker.build("cicd-test/frontend:$BUILD_NUMBER", "-f Dockerfile .")
                        customImage.push()
                        customImage.push("latest")                            
                        // Deploy the service
                        // Uncomment the following lines if needed
                        sh "SERVICE_NAME=$service_name SERVICE_PORT=3000 IMAGE_NAME=cicd-test/frontend IMAGE_VERSION=$BUILD_NUMBER ENV=dev envsubst < deployment.yaml | kubectl apply -f -"
                        // sh "kubectl set image deployment/${env.SERVICE_NAME} ${env.SERVICE_NAME}=cicd-test/frontend:${env.BUILD_NUMBER} -n ${env.NS}"                    
                    }
                }
            }
        }
    }
    post {
        always {
            // Actions to perform after the pipeline runs, e.g., cleanup, notifications
            sh 'echo POST ACTIONS'
        }
    }
}
